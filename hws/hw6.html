<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="../JSLibrary/Rectangle.js"></script>
    <script src="../JSLibrary/utils.js"></script>
    <style>
        h3 {
            font-family:Arial, Helvetica, sans-serif;
            color: green;
        }

        body{
            font-family:Arial, Helvetica, sans-serif;
            background-color:#FFFAED;
        }

        label {
            font-weight: bold;
            color:navy;
        }

        input[type="number"] {
            margin-right: 20px;
        }

        canvas {
            background-color: #17181B;
            border: 2px solid green;
            vertical-align: top;
        }
    </style>
    <title>Attack Simulation - Gambler's</title>
</head>

<body>

    <h3>HW. 6 - Attack Simulation: Gambler's Ruin Problem</h3>

    <label for="inputSystems"># Systems: </label>
    <input type="number" id="inputSystems" value=100 min="10" max="1000" step="10">

    <label for="inputAttacks"># Attacks: </label>
    <input type="number" id="inputAttacks" value=2000 min="10" max="8000" step="10">

    <label for="securityScore">Security score S: </label>
    <input type="number" id="securityScore" value=20 min="20" max="200" step="20">

    <button id="compute" type="button" style="margin-right: 20px;">Simulate</button>

    <hr>
    <canvas id="myChart" width="900" height="600" oncontextmenu="return false"></canvas>

    <script>

        "use strict";

        const buttonCompute = document.getElementById("compute");
        const inputSystems = document.getElementById("inputSystems");
        const inputAttacks = document.getElementById("inputAttacks");
        const securityScore = document.getElementById("securityScore"); // Security Score

        const myChart = document.getElementById("myChart"); // Get the canvas element by its ID
        const rct = myChart.getContext("2d"); // Get the 2D rendering context, the rectangle where i draw

        let nSystems, nAttacks, S;
        let xOrigin, yOrigin;
        let allLines; // contains all the lines to be drawn
        let myRandomY;
        let myFrequency;
        let minValue, maxValue, rangeValues;
        let penetrations; // contains the FREQUENCIES of the penetrations
        let P; // penetration Score


        const rectChart = new Rectangle(20, 30, myChart.width - 200, myChart.height - 60); // chart where there are the histograms
        buttonCompute.onclick = main;
        //main();

        // It gets the values passed from the user
        function calcGraphicsValues() {

            nAttacks = Math.round(Number(inputAttacks.value));
            nSystems = Number(inputSystems.value);
            S = -Number(securityScore.value);
            //console.log(S); 

            const rangeScaler = 4;

            minValue = -rangeScaler * Math.sqrt(nAttacks);
            maxValue = rangeScaler * Math.sqrt(nAttacks);

            myRandomY = () => utils.RademacherDist(0.5); // generate the random value for the attack
            myFrequency = (y) => y; // javaScript arrow (lambda) function

            rangeValues = maxValue - minValue;
            [xOrigin, yOrigin] = utils.XYtoDevice([0, 0], 0, nAttacks, minValue, rangeValues, rectChart);
            //add others values if you want...
        }


        function main() {

            calcGraphicsValues();

            // clear stuff
            rct.clearRect(0, 0, myChart.width, myChart.height);
            penetrations = new Array(10).fill(0);
            //allLines = [];

            // generate multiple attack lines (one for each system)
            for (let m = 1; m <= nSystems; m++) {
                const newLine = drawLine(penetrations); // draw line for system m and update penetrations array
                //allLines.push(newLine); // add the line to the list wich contains all the lines
                rct.lineWidth = 1;
                rct.strokeStyle = utils.randomColorCSS()// set the stroke of the line
                rct.stroke(newLine);
            }

            //console.log(histoFrequencies); // Add this line to inspect histoFrequencies
            rectChart.drawRectangle(rct, "white", 2, []);
            const HistogramRectangle = new Rectangle(utils.XtoDevice(nAttacks, 0, nAttacks, rectChart.x, rectChart.width), rectChart.y, 160, rectChart.height) // instantiate new rectangle for the histograms
            HistogramRectangle.drawRectangle(rct, "rgba(0,100,160,0.5)", 2, [1, 1]); // draw this rectangle
            utils.drawHistogramsFromArr(rct, penetrations, HistogramRectangle, "red", "lightgreen");
        }



        // The function which draw the lines. The way in which i draw is the same for all the cases (changes the getUserValues instead)
        function drawLine(frequencies) {
            const myLine = new Path2D(); // the line which i draw

            let y = 0; // Y coordinates
            let prevY = yOrigin;

            myLine.moveTo(xOrigin, yOrigin);  

            for (let x = 1; x <= nAttacks; x++) { // X coordinates

                y += myRandomY(); // security/penetration score
                let frequency = myFrequency(y);

                const xDevice = utils.XtoDevice(x / nAttacks, 0, 1, rectChart.x, rectChart.width);
                const yDevice = utils.YtoDevice(frequency, minValue, rangeValues, rectChart.y, rectChart.height);

                myLine.lineTo(xDevice, prevY);
                prevY = yDevice
                myLine.lineTo(xDevice, yDevice);

                // P penetration score (upper line)
                // S security score (lower line)

                if (y == S) {  // If the system reaches a security score of S is OKAY
                    continue;
                }
                else {
                    for (let k = 0; k < 10; k++) {
                        P = (k + 1) * 10; // Compute value of P bounder
                        if (y == P) { // If the system reaches the penetration score P
                            frequencies[k] += 1; // number of frequencies which fall in intervall k
                        }
                    }
                }
            }
            return myLine;
        }

    </script>
</body>
</html>
